<!DOCTYPE html>
<html>
    <head>
        <link href="https://fonts.googleapis.com/css?family=Open+Sans|Ubuntu+Mono&display=swap" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="./include/style.css">
        <title>Andrew Gu - FIDO/U2F in detail</title>
    </head>
    <body>
        <div class="page-header">
            FIDO/U2F Protocol Annotated
            <span class="subtitle">Inspired by <a target="_blank" href="https://tls13.ulfheim.net/">The Illustrated TLS Connection</a></span>
            <h1>Why write this?</h1>
            <p>
                When I was writing FIDO/U2F multi-factor authentication for my own project, I couldn't find any good tutorials.
            </p>
            <p>    
                In typical unsatisfying tutorial fashion (I'm talking to you, unnamed Medium tutorials), 
                every one regurgitated the browser-side JavaScript calls for prompting the user and said nothing
                about the remaining 95% of the details. 
                What do my servers need to do? What do these JSON objects 
                actually mean? How do I actually verify the user?
            </p>
            <p>
                This is my attempt at a <em>useful</em> tutorial.
            </p>
            <h1>What isn't covered?</h1>
            <p>
                This is for FIDO version 1, aka U2F. FIDO2 follows the same principles but works slightly differently.
            </p>
            <h1 class="phase-name">
                Prerequisites
            </h1>
            <p>
                The demo code requires <a target="_blank" href="https://www.python.org/">Python 3</a> and the <a target="_blank" href="https://github.com/Yubico/python-fido2">fido2</a> package:
                <code>&gt; pip install fido2</code>
            </o>
            <p>
                JavaScript parts can be run in your browser's dev console.
            </p>
        </div>
        <div class="content-root">
            <h1>Registration</h1>
            <div class="protocol-phase client-phase" expandable>
                <h1 class="phase-name" expandtoggle>
                    <span class="expand">+</span>
                    <span class="shrink">−</span>
                    &#x2b92; Open HTTPS Connection
                </h1>
                <div class="details">
                    <p>
                        How you do this is up to you, but make sure you do it.
                    </p>
                    <p>
                        First you need a secure connection between the client and server, which is probably done with HTTPS. 
                        This is to prevent a man-in-the-middle attack which would allow
                        an attacker to impersonate either the server or the FIDO authenticator.
                    </p>
                    <p>
                        If you are writing a website, you get this with your standard HTTPS everywhere setup.
                        If you are writing a native client, HTTPS will do the job, though technically you could do it some other way.
                    </p>
                </div>
            </div>
            <div class="protocol-phase client-phase" expandable>
                <h1 class="phase-name" expandtoggle>
                    <span class="expand">+</span>
                    <span class="shrink">−</span>
                    &#x2b92; Bootstrap Login
                </h1>
                <div class="details">
                    <p>
                        How you do this is up to you, but make sure you do it.
                    </p>
                    <p>
                        You need some way to connect the second factor to the user. You usually do this by having the user create an 
                        account (e.g. email and password). When they log in with that, you get a user ID for linking their second factor.
                    </p>
                    <p>
                        If you are requiring 2FA/MFA, then you might restrict the user account like an "unverified" account until the
                        FIDO authenticator is set up.
                    </p>
                </div>
            </div>
            <div class="protocol-phase server-phase" expandable>
                <h1 class="phase-name" expandtoggle>
                    <span class="expand">+</span>
                    <span class="shrink">−</span>
                    &#x21c7; Server Challenge
                </h1>
                <div class="details">
                    <h2>
                        Generating a Secure Challenge
                    </h2>
                    <p>
                        Registration begins with the server generating a random challenge (binary blob).
                        The challenge will be signed using a private key stored on the FIDO authenticator.
                    </p>
                    <div class="code-paragraph" expandable>
                        <div class="code">
                            4b2fe77263b28031b396140f8460863fe80b88ebb974a9e6a1069ca4040bf547
                        </div>
                        <input type="button" value="Show Code" expandtoggle>
                        <div class="details">
                            <div class="code">
                                # python<br>
                                from binascii import hexlify<br>
                                from secrets import token_bytes<br>
                                <span class="has-tooltip">
                                    CHALLENGE_LENGTH = 32
                                    <div class="tooltip-text" style="width: 350px; padding-top: 5px;">32 bytes is probably enough, requiring 2<sup>128</sup> guesses for a birthday attack.</div>
                                </span>
                                <br>
                                challenge = token_bytes(CHALLENGE_LENGTH)<br>
                                print(hexlify(challenge))
                            </div>
                        </div>
                        <p>
                            It's crucial that the server generates a <em>random</em> challenge so that it's not possible 
                            for an eavesdropper to replay a previous registration.
        
                            The server needs to remember that this challenge is for this specific user.
                        </p>
                    </div>
                    <h2>
                        Transmitting to Client
                    </h2>
                    <p>
                        Before we can send the challenge to the actual FIDO authenticator, we will need to encode it using <a target="_blank" href="https://en.wikipedia.org/wiki/Base64#Implementations_and_history">base64url without padding</a>.
                        Technically we don't have to do the base 64 encoding until the next step (client talking to the FIDO authenticator), but base64 is convenient for returning a binary blob in a HTTP response body, so we might as well encode it on the server.
                    </p>
                    <div class="code-paragraph" expandable>
                        <div class="code">
                            Sy_ncmOygDGzlhQPhGCGP-gLiOu5dKnmoQacpAQL9Uc
                        </div>
                        <input type="button" value="Show Code" expandtoggle>
                        <div class="details">
                            <p>
                                Convert into base64url without padding:
                            </p>
                            <div class="code">
                                # python<br>
                                from fido2.utils import websafe_encode<br>
                                websafe_encode(challenge)
                            </div>
                            <p>
                                You could generate the challenge straight into base64url, but remember that you will have to verify the response using the <em>decoded</em> bit sequence.
                            </p>
                            <div class="code">
                                # python<br>
                                from secrets import token_urlsafe<br>
                                CHALLENGE_LENGTH = 32
                                challenge = token_urlsafe(CHALLENGE_LENGTH).replace('=','')<br>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="protocol-phase client-phase" expandable>
                <h1 class="phase-name" expandtoggle>
                    <span class="expand">+</span>
                    <span class="shrink">−</span>
                    <!--&#x1f5a2;-->User Prompt
                </h1>              
                <div class="details" tabcontainer>
                    <p>
                        The browser (or your native app) needs to take the challenge from the server and generate a response that could only come from your FIDO authenticator. 
                        This process works differently depending on whether you're doing this from a browser or from native code. 
                    </p>  
                    <div class="tab-selector">
                        <input id="client-phase-webauthn-tab" type="radio" name="reg-prompt-user-nav" checked>
                        <label for="client-phase-webauthn-tab">Browser</label>
                        <input id="client-phase-python-tab" type="radio" name="reg-prompt-user-nav">
                        <label for="client-phase-python-tab">Native</label>
                        &nbsp;
                    </div>
                    <div class="tab-container">
                        <div class="tab-content" fortab="client-phase-webauthn-tab">
                            <h2>
                                Prompting using WebAuthn in the Browser
                            </h2>
                            <p>
                                Browsers implement the WebAuthn API, which your JavaScript will call. It hides the complexities of actually talking
                                to the authenticator device, so I recommend using WebAuthn where you can.
                            </p>
                            <p>
                                This example doesn't cover all of the configuration options. It just illustrates a typical sane setup.
                            </p>
                        </div>
                        <div class="tab-content" fortab="client-phase-python-tab">
                            <h2>
                                Prompting in a Native Application
                            </h2>
                            <p>
                                In a native application, you can still just embed a browser to use WebAuthn. However, if that isn't an option, you can try to talk to the authenticator directly.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="protocol-phase client-phase" expandable>
                <h1 class="phase-name" expandtoggle>
                    <span class="expand">+</span>
                    <span class="shrink">−</span>
                    &#x21c9; Signed Response
                </h1>
                <div class="details">
                    <p>
                        Client sends response with protocol bullshit
                    </p>
                </div>
            </div>
            <div class="protocol-phase server-phase" expandable>
                <h1 class="phase-name" expandtoggle>
                    <span class="expand">+</span>
                    <span class="shrink">−</span>
                    Validate Response
                </h1>
                <div class="details">
                    <p>
                        Server stores registration info
                    </p>
                </div>
            </div>
            <div class="protocol-phase server-phase" expandable>
                <h1 class="phase-name" expandtoggle>
                    <span class="expand">+</span>
                    <span class="shrink">−</span>
                    Save Registration
                </h1>
                <div class="details">
                    <p>
                        Server stores registration info
                    </p>
                </div>
            </div>
        </div>
        <div class="content-root">
            <h1>Title H1</h1>
            <h2>Section H2</h2>
            <h3>Subheading H3</h3>
            <p>Body text <a href="https://fidoalliance.org/specifications/">Reference Link</a></p>
            <code class="python">This is python code</code>
            <code class="javascript">This is javascript code</code>
            <code class="json">{inline json stuff}</code>
            <code class="hex">01 23 45 67 89 0A BC DE F0</code>
            <code class="base64">ThisIsWebSafeBase64</code>

            <div class="protocol-phase expandable" id="test_expandable">
                <div class="expandable-inner">
                    <div class="protocol-phase-header header">
                        <input class="protocol-phase-toggle" type="button" value="Explain" expandtarget="test_expandable">
                        <div class="protocol-phase-previewer">Name of Protocol Phase</div>
                    </div>
                    <div class="protocol-phase-detail detail">
                        <h1>Detail of Protocol Phase</h1>

                        <p>Explanation stuff here.</p>
                        <!--
                        <div class="data expandable" id="test_data">
                            <div class="data-header header" previewer>
                                <input class="data-toggle" type="button" value="Annotate" expandtarget="test_data">
                                <div class="data-previewer" preview>
                                    <code class="json">{Collapsed Json}</code>
                                </div>
                            </div>
                            <div class="data-expanded">
                                <code class="json">00 00 00 00</code>
                                <p>Description</p>
                                <code class="json">00 00 00 00</code>
                                <p>Description</p>
                                <code class="json">00 00 00 00</code>
                                <p>Description</p>
                            </div>
                        </div>

                        <div class="blob expandable" id="test_blob">
                            <div class="blob-header header" previewer>
                                <input class="blob-toggle" type="button" value="Decode" expandtarget="test_blob">
                                <div class="blob-previewer">
                                    <code class="base64">Base 64</code>
                                </div>
                            </div>
                            <div class="blob-expanded">
                                <code class="hex">00 00 00 00</code>
                            </div>
                        </div>

                        <div class="show-code expandable" id="test_showcode">
                            <div class="show-code-header header">
                                <input class="show-code-expand-button" type="button" value="Code" expandtarget="test_showcode" previewer>
                            </div>
                            <code class="show-code-expanded python">Detail code</code>
                        </div>
                        -->
                    </div>
                </div>
            </div>
        </div>
        <div class="page-footer">
            &copy; 2019 Andrew Gu | MIT License
        </div>
    </body>
    <script type="text/javascript" src="./include/util.js"></script>
    <script type="text/javascript">
        var formatMapping = {
            "expandable_attrb" : "expandable",
            "toggle_attrb" : "expandtoggle",
            "collapse_class" : "collapsed",
            "toggle_state_attrb" : "togglecollapsed",
            "tab_container_attrb" : "tabcontainer",
            "tab_selector_class" : "tab-selector",
            "tab_content_class" : "tab-content",
            "tab_content_key_attrb" : "fortab",
            "tab_visiblity_class" : "visible",
        };
        initInteractiveFormatting(formatMapping);
    </script>
</html>