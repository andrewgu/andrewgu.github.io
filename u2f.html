<!DOCTYPE html>
<html>
    <head>
        <link href="https://fonts.googleapis.com/css?family=Open+Sans|Ubuntu+Mono&display=swap" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="./include/style.css">
        <title>Andrew Gu - FIDO/U2F in detail</title>
    </head>
    <body>
        <div class="page-header">
            FIDO/U2F Protocol Annotated
            <span class="subtitle">Inspired by <a target="_blank" href="https://tls13.ulfheim.net/">The Illustrated TLS Connection</a></span>
            <h1>Why write this?</h1>
            <p>
                When I was writing FIDO/U2F multi-factor authentication for my own project, I couldn't find any good tutorials.
            </p>
            <p>    
                In typical unsatisfying tutorial fashion (I'm talking to you, unnamed Medium tutorials), 
                every one regurgitated the browser-side JavaScript calls for prompting the user and said nothing
                about the remaining 95% of the details. 
                What do my servers need to do? What do these JSON objects 
                actually mean? How do I actually verify the user?
            </p>
            <p>
                This is my attempt at a <em>useful</em> tutorial.
            </p>
            <h1>What isn't covered?</h1>
            <p>
                This is for FIDO version 1, aka U2F. FIDO2 follows the same principles but works slightly differently.
            </p>
            <h1 class="phase-name">
                Prerequisites
            </h1>
            <p>
                The demo code requires <a target="_blank" href="https://www.python.org/">Python 3</a> and the <a target="_blank" href="https://github.com/Yubico/python-fido2">fido2</a> package:
                <code>&gt; pip install fido2</code>
            </o>
            <p>
                JavaScript parts can be run in your browser's dev console.
            </p>
        </div>
        <div class="content-root">
            <h1>Registration</h1>
            <div class="protocol-phase client-phase" expandable>
                <h1 class="phase-name" expandtoggle>
                    <span class="expand">+</span>
                    <span class="shrink">−</span>
                    &#x2b92; Connect with HTTPS
                </h1>
                <div class="details">
                    <p>
                        The client (or browser) first makes a HTTPS connection with the server. 
                        This is to prevent a man-in-the-middle attack which would allow
                        an attacker to impersonate either the server (replay attack) or the FIDO authenticator.
                    </p>
                    <p>
                        If you are writing a website, you get this for free with your standard HTTPS everywhere setup.
                        If you are writing a native client, make sure you are using HTTPS to talk to your servers.
                    </p>
                </div>
            </div>
            <div class="protocol-phase client-phase" expandable>
                <h1 class="phase-name" expandtoggle>
                    <span class="expand">+</span>
                    <span class="shrink">−</span>
                    &#x2b92; User Login
                </h1>
                <div class="details">
                    <p>
                        You need some way to connect data in the registration process to the user's account. Typically, you do this
                        by having the user log in. If they haven't enabled 2FA/MFA yet, then it's usually just username + password until
                        2FA/MFA is set up.
                    </p>
                    <p>
                        If you are requiring 2FA/MFA, then you might restrict the user account like an "unverified" account until the
                        FIDO authenticator is set up.
                    </p>
                </div>
            </div>
            <div class="protocol-phase server-phase" expandable>
                <h1 class="phase-name" expandtoggle>
                    <span class="expand">+</span>
                    <span class="shrink">−</span>
                    &#x21c7; Server Challenge
                </h1>
                <div class="details">
                    <p>
                        Registration begins with the server generating a random challenge string.
                        The challenge string will be signed using a private key stored on the FIDO authenticator.
                    </p>
                    <div class="code-paragraph" expandable>
                        <div class="code">
                            4b2fe77263b28031b396140f8460863fe80b88ebb974a9e6a1069ca4040bf547
                        </div>
                        <input type="button" value="Show Code" expandtoggle>
                        <div class="details">
                            <div class="code">
                                # python<br>
                                from binascii import hexlify<br>
                                from secrets import token_bytes<br>
                                <span class="has-tooltip">
                                    CHALLENGE_LENGTH = 32
                                    <div class="tooltip-text" style="width: 350px; padding-top: 5px;">32 bytes is probably enough, requiring 2<sup>128</sup> guesses for a birthday attack.</div>
                                </span>
                                <br>
                                challenge = token_bytes(CHALLENGE_LENGTH)<br>
                                print(hexlify(challenge))
                            </div>
                        </div>
                    </div>
                    <p>
                        For transmitting the challenge, we will need to encode it using <a target="_blank" href="https://en.wikipedia.org/wiki/Base64#Implementations_and_history">base64url without padding</a>:
                    </p>
                    <div class="code-paragraph" expandable>
                        <div class="code">
                            Sy_ncmOygDGzlhQPhGCGP-gLiOu5dKnmoQacpAQL9Uc
                        </div>
                        <input type="button" value="Show Code" expandtoggle>
                        <div class="details">
                            <p>
                                Convert into base64url without padding:
                            </p>
                            <div class="code">
                                # python<br>
                                from fido2.utils import websafe_encode<br>
                                websafe_encode(challenge)
                            </div>
                            <p>
                                Or you can generate the challenge straight into base64url:
                            </p>
                            <div class="code">
                                # python<br>
                                from secrets import token_urlsafe<br>
                                CHALLENGE_LENGTH = 32
                                challenge = token_urlsafe(CHALLENGE_LENGTH).replace('=','')<br>
                            </div>
                        </div>
                    </div>
                    <p>
                        It's crucial that the server generates a <em>random</em> string so that it's not possible 
                        for an eavesdropper to replay a previous registration.
    
                        The server needs to remember that this challenge is for the specific user.
                    </p>
                </div>
            </div>
            <div class="protocol-phase client-phase" expandable>
                <h1 class="phase-name" expandtoggle>
                    <span class="expand">+</span>
                    <span class="shrink">−</span>
                    <!--&#x1f5a2;-->User Prompt
                </h1>
                <div class="details with-tabs">
                    <div class="tab">
                        <input id="client-phase-webauthn-tab" type="radio" name="reg-prompt-user-nav" checked>
                        <label for="client-phase-webauthn-tab">Browser (WebAuthn)</label>
                        <div class="tab-content">
                            WebAuthn details
                        </div>
                    </div>
                    <div class="tab">
                        <input id="client-phase-python-tab" type="radio" name="reg-prompt-user-nav">
                        <label for="client-phase-python-tab">Native (Python)</label>
                        <div class="tab-content">
                            Python details
                        </div>
                    </div>
                </div>
            </div>
            <div class="protocol-phase client-phase" expandable>
                <h1 class="phase-name" expandtoggle>
                    <span class="expand">+</span>
                    <span class="shrink">−</span>
                    &#x21c9; Signed Response
                </h1>
                <div class="details">
                    <p>
                        Client sends response with protocol bullshit
                    </p>
                </div>
            </div>
            <div class="protocol-phase server-phase" expandable>
                <h1 class="phase-name" expandtoggle>
                    <span class="expand">+</span>
                    <span class="shrink">−</span>
                    Validate Response
                </h1>
                <div class="details">
                    <p>
                        Server stores registration info
                    </p>
                </div>
            </div>
            <div class="protocol-phase server-phase" expandable>
                <h1 class="phase-name" expandtoggle>
                    <span class="expand">+</span>
                    <span class="shrink">−</span>
                    Save Registration
                </h1>
                <div class="details">
                    <p>
                        Server stores registration info
                    </p>
                </div>
            </div>
        </div>
        <div class="content-root">
            <h1>Title H1</h1>
            <h2>Section H2</h2>
            <h3>Subheading H3</h3>
            <p>Body text <a href="https://fidoalliance.org/specifications/">Reference Link</a></p>
            <code class="python">This is python code</code>
            <code class="javascript">This is javascript code</code>
            <code class="json">{inline json stuff}</code>
            <code class="hex">01 23 45 67 89 0A BC DE F0</code>
            <code class="base64">ThisIsWebSafeBase64</code>

            <div class="protocol-phase expandable" id="test_expandable">
                <div class="expandable-inner">
                    <div class="protocol-phase-header header">
                        <input class="protocol-phase-toggle" type="button" value="Explain" expandtarget="test_expandable">
                        <div class="protocol-phase-previewer">Name of Protocol Phase</div>
                    </div>
                    <div class="protocol-phase-detail detail">
                        <h1>Detail of Protocol Phase</h1>

                        <p>Explanation stuff here.</p>
                        <!--
                        <div class="data expandable" id="test_data">
                            <div class="data-header header" previewer>
                                <input class="data-toggle" type="button" value="Annotate" expandtarget="test_data">
                                <div class="data-previewer" preview>
                                    <code class="json">{Collapsed Json}</code>
                                </div>
                            </div>
                            <div class="data-expanded">
                                <code class="json">00 00 00 00</code>
                                <p>Description</p>
                                <code class="json">00 00 00 00</code>
                                <p>Description</p>
                                <code class="json">00 00 00 00</code>
                                <p>Description</p>
                            </div>
                        </div>

                        <div class="blob expandable" id="test_blob">
                            <div class="blob-header header" previewer>
                                <input class="blob-toggle" type="button" value="Decode" expandtarget="test_blob">
                                <div class="blob-previewer">
                                    <code class="base64">Base 64</code>
                                </div>
                            </div>
                            <div class="blob-expanded">
                                <code class="hex">00 00 00 00</code>
                            </div>
                        </div>

                        <div class="show-code expandable" id="test_showcode">
                            <div class="show-code-header header">
                                <input class="show-code-expand-button" type="button" value="Code" expandtarget="test_showcode" previewer>
                            </div>
                            <code class="show-code-expanded python">Detail code</code>
                        </div>
                        -->
                    </div>
                </div>
            </div>
        </div>
        <div class="page-footer">
            &copy; 2019 Andrew Gu | MIT License
        </div>
    </body>
    <script type="text/javascript" src="./include/util.js"></script>
    <script type="text/javascript">
        var formatMapping = {
            "expandable_attrb" : "expandable",
            "toggle_attrb" : "expandtoggle",
            "collapse_class" : "collapsed",
            "toggle_state_attrb": "togglecollapsed",
        };
        initInteractiveFormatting(formatMapping);
    </script>
</html>