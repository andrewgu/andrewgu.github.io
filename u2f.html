<!DOCTYPE html>
<html>
    <head>
        <link href="https://fonts.googleapis.com/css?family=Open+Sans|Ubuntu+Mono&display=swap" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="./include/style.css">
        <title>Andrew Gu - FIDO/U2F in detail</title>
    </head>
    <body>
        <div class="page-header">
            FIDO/U2F Protocol Annotated
            <span class="subtitle">Inspired by <a target="_blank" href="https://tls13.ulfheim.net/">The Illustrated TLS Connection</a></span>
            <h1>Why write this?</h1>
            <p>
                When I was writing FIDO/U2F multi-factor authentication for my own project, I couldn't find any good tutorials.
            </p>
            <p>    
                In typical unsatisfying tutorial fashion, you get to choose between Medium posts that don't tell you remotely
                enough, and highly detailed posts and specs that put you in front of the firehose.
            </p>
            <p>
                This is my attempt at a tutorial that introduces FIDO bit by bit. I've included references and links
                to my source material (the firehose) at the bottom.
            </p>
            <h1>What isn't covered?</h1>
            <p>
                TL;DR There are three-ish versions of the protocol. There's the old U2F, then there's FIDO and FIDO2. 
                This covers FIDO mostly and stays away from the extra stuff that FIDO2 adds.
            </p>
            <h1 class="phase-name">
                Prerequisites
            </h1>
            <p>
                You will need a FIDO authenticator to follow this tutorial. I used a YubiKey 4.
                FIDO2 is not covered in the example code, so YubiKey 5's, Android authenticator, etc. which are FIDO2 will not work. 
                However, you can get them working with some adjustments.
            </p>
            <p>
                The demo code uses <a target="_blank" href="https://www.python.org/">Python 3</a> and several packages that aren't installed by default:
                <code>
                    &gt; pip install fido2
                    &gt; pip install cbor2
                </code>
            </o>
            <p>
                JavaScript parts can be run in your browser's dev console.
            </p>
        </div>
        <div class="content-root">
            <h1>Registration</h1>
            <div class="protocol-phase client-phase" expandable>
                <h1 class="phase-name" expandtoggle>
                    <span class="expand">+</span>
                    <span class="shrink">−</span>
                    &#x2b92; Open HTTPS Connection
                </h1>
                <div class="details">
                    <p>
                        The browser will do this for you. If you are writing a native client, you should still use HTTPS.
                        It accomplishes two key things:
                    </p>
                    <ol>
                        <li>Prevent man in the middle attacks</li>
                        <li>Prove your server is actually you</li>
                    </ol>
                </div>
            </div>
            <div class="protocol-phase client-phase" expandable>
                <h1 class="phase-name" expandtoggle>
                    <span class="expand">+</span>
                    <span class="shrink">−</span>
                    &#x2b92; Bootstrap Login
                </h1>
                <div class="details">
                    <p>
                        You need a user ID that you can register the FIDO authenticator to. You usually do this by having the user create an 
                        account (e.g. email and password).
                    </p>
                    <p>
                        Best practice is to restrict what the account can access until it has a second factor set up. You should support
                        registering multiple authenticators per user so that users can set up multiple in case they lose one.
                    </p>
                </div>
            </div>
            <div class="protocol-phase server-phase" expandable>
                <h1 class="phase-name" expandtoggle>
                    <span class="expand">+</span>
                    <span class="shrink">−</span>
                    &#x21c7; Server Challenge
                </h1>
                <div class="details">
                    <h2>
                        Generating a Secure Challenge
                    </h2>
                    <p>
                        Registration begins with the server generating a random challenge (binary blob).
                        The challenge will be signed using a private key stored on the FIDO authenticator.
                    </p>
                    <div class="code-paragraph" expandable>
                        <div class="code">
                            4b2fe77263b28031b396140f8460863fe80b88ebb974a9e6a1069ca4040bf547
                        </div>
                        <input type="button" value="Show Code" expandtoggle>
                        <div class="details">
                            <div class="code">
                                # python<br>
                                from binascii import hexlify<br>
                                from secrets import token_bytes<br>
                                <span class="has-tooltip">
                                    CHALLENGE_LENGTH = 32
                                    <div class="tooltip-text" style="width: 350px; padding-top: 5px;">32 bytes is probably enough, requiring 2<sup>128</sup> guesses for a birthday attack.</div>
                                </span>
                                <br>
                                challenge = token_bytes(CHALLENGE_LENGTH)<br>
                                print(hexlify(challenge))
                            </div>
                        </div>
                        <p>
                            The challenge must be <em>random</em> so that an eavesdropper can't replay a previous registration.
        
                            The server needs to remember that this challenge is for this specific user.
                        </p>
                    </div>
                    <h2>
                        Transmitting to Client
                    </h2>
                    <p>
                        Before we can send the challenge to the actual FIDO authenticator, we will need to encode it using <a target="_blank" href="https://en.wikipedia.org/wiki/Base64#Implementations_and_history">base64url without padding</a>.
                        Technically we don't have to do the base 64 encoding until the next step (client talking to the FIDO authenticator), but base64 is convenient for returning a binary blob in a HTTP response body.
                    </p>
                    <div class="code-paragraph" expandable>
                        <div class="code">
                            Sy_ncmOygDGzlhQPhGCGP-gLiOu5dKnmoQacpAQL9Uc
                        </div>
                        <input type="button" value="Show Code" expandtoggle>
                        <div class="details">
                            <p>
                                Convert into base64url without padding:
                            </p>
                            <div class="code">
                                # python<br>
                                from fido2.utils import websafe_encode<br>
                                websafe_encode(challenge)
                            </div>
                            <p>
                                You could generate the challenge straight into base64url, but remember that you will have to verify the response using the <em>decoded</em> bit sequence.
                            </p>
                            <div class="code">
                                # python<br>
                                from secrets import token_urlsafe<br>
                                CHALLENGE_LENGTH = 32
                                challenge = token_urlsafe(CHALLENGE_LENGTH).replace('=','')<br>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="protocol-phase client-phase" expandable>
                <h1 class="phase-name" expandtoggle>
                    <span class="expand">+</span>
                    <span class="shrink">−</span>
                    <!--&#x1f5a2;-->User Prompt
                </h1>
                <div class="details" tabcontainer>
                    <p>
                        Using the challenge from the server and the "relying party ID" (domain name), the browser/native client asks
                        the authenticator to generate a key pair that is unique for your site/app.
                    </p>  
                    <div class="tab-selector">
                        <input id="client-phase-webauthn-tab" type="radio" name="reg-prompt-user-nav" checked>
                        <label for="client-phase-webauthn-tab">Browser</label>
                        <input id="client-phase-python-tab" type="radio" name="reg-prompt-user-nav">
                        <label for="client-phase-python-tab">Native</label>
                        &nbsp;
                    </div>
                    <div class="tab-container">
                        <div class="tab-content" fortab="client-phase-webauthn-tab">
                            <h2>
                                Browser (WebAuthn)
                            </h2>
                            <p>
                                In browsers, the easiest way is to call the <a target="_blank" href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Authentication_API">WebAuthn API</a> with JavaScript. 
                                This example covers the basic implementation using sensible defaults.
                            </p>
                            <p>
                                There are three steps:
                            </p>
                            <div class="subsection" expandable>
                                <h3 expandtoggle>
                                    <span class="expand">+</span>
                                    <span class="shrink">−</span>
                                    Set up the options object
                                </h3>
                                <div class="details">
                                    <div class="code-paragraph" expandable>
                                        <div class="short">
                                            <input type="button" value="Line by Line" expandtoggle>
                                            <div class="code">
                                                var options = {<br>
                                                <span tab></span>publicKey: {<br>
                                                <span tab__></span>rp: {<br>
                                                <span tab____></span>id: <span class="has-tooltip">"localhost"<div class="tooltip-text" style="width: 350px; padding-top: 5px;">Typically your domain name. "localhost" for testing.</div></span>,<br>
                                                <span tab____></span>name: <span class="has-tooltip">"Test App"<div class="tooltip-text" style="width: 300px; padding-top: 5px;">Friendly name for the prompt</div></span><br>
                                                <span tab__></span>},<br>
                                                <span tab__></span>challenge: <span class="has-tooltip">base64urlToBuffer(serverChallenge)<div class="tooltip-text" style="width: 300px; padding-top: 5px;">Raw bits of the server challenge</div></span>,<br>
                                                <span tab__></span>user: {<br>
                                                <span tab____></span>displayName: <span class="has-tooltip">"Test User"<div class="tooltip-text" style="width: 300px; padding-top: 5px;">Friendly name</div></span>,<br>
                                                <span tab____></span>name: test_user@example.com,<br>
                                                <span tab____></span>id: <span class="has-tooltip">base64urlToBuffer(userId)<div class="tooltip-text" style="width: 350px; padding-top: 5px;">Actual user identifier used for verification. This can be just the UTF-8 encoded user name.</div></span><br>
                                                <span tab__></span>},<br>
                                                <span tab__></span>pubKeyCredParams: [<br>
                                                <span tab____></span>{<br>
                                                <span tab______></span>type: <span class="has-tooltip">"public-key"<div class="tooltip-text" style="width: 300px; padding-top: 5px;">Magic word for "FIDO"</div></span>,<br>
                                                <span tab______></span>alg: <span class="has-tooltip">-7<div class="tooltip-text" style="width: 350px; padding-top: 5px; left: -13px;">-7 is the magic number for ECDSA w/ SHA-256 signature algorithm. -37 is also common for RSA w/ SHA-256.<sup>1</sup></div></span><br>
                                                <span tab____></span>}<br>
                                                <span tab__></span>],<br>
                                                <span tab__></span>timeout: <span class="has-tooltip">30000<div class="tooltip-text" style="width: 350px; padding-top: 5px; left: -10px;">Time in milliseconds before the prompt should time out.</div></span>,<br>
                                                <span tab__></span>attestation: <span class="has-tooltip">"direct"<div class="tooltip-text" style="width: 350px; padding-top: 5px; left: -10px;">"Direct" means that a hardware attestation is required.</div></span><br>
                                                <span tab></span>}<br>
                                                };
                                            </div>
                                        </div>
                                        <div class="details no-indent">
                                            <input type="button" value="Short Version" expandtoggle>
                                            <p>
                                                You can find an excellent reference for the options object in <a target="_blank" href="https://developer.mozilla.org/en-US/docs/Web/API/PublicKeyCredentialCreationOptions">MDN</a>.
                                            </p>

                                            When creating this object, we need to know a few things like the user's ID and the server challenge. The API expects them as Buffer objects, 
                                            so we need a helper function:

<pre><code>function base64urlToBuffer(base64url)
{
    var rawString = window.atob(base64url.replace(/_/g, "/").replace(/-/g, "+"));
    var buffer = new ArrayBuffer(rawString.length);
    var array = new Uint8Array(buffer);
    for (var i = 0; i < rawString.length; i++) {
        array[i] = rawString.charCodeAt(i);
    }
    return buffer;
}</code></pre>
                                            <p>
                                                We know our server challenge's base64url encoding from before:
                                            </p>
                                            <pre><code>var serverChallenge = "Sy_ncmOygDGzlhQPhGCGP-gLiOu5dKnmoQacpAQL9Uc"</code></pre>
                                            <p>
                                                We also need a unique identifier for the user. This identifier should  not change if the user changes their email address, etc. We'll just make up some base64 for now.
                                            </p>
                                            <pre><code>var userId = "abcdef"</code></pre>
                                            <p>
                                                The options object contains a single field "publicKey" and the value is a <span class="mono"><a target="_blank" href="https://developer.mozilla.org/en-US/docs/Web/API/PublicKeyCredentialCreationOptions">PublicKeyCredentialCreationOptions</a></span>.
                                            </p>
                                            <pre><code>var options = {
    publicKey: {</code></pre>
                                            <p>
                                                In most cases, "relying party" just means your domain name. The browser checks that it matches your SSL certificate. "localhost" is an exception, useful for testing.
                                            </p>
                                            <pre><code>        rp: {
            id: "localhost",
            name: "Test App"
        },</code></pre>
                                            <p>
                                                The API expects us to pass in a byte buffer, so we decode the base64 using the helper function up above:
                                            </p>
                                            <pre><code>        challenge: base64urlToBuffer(serverChallenge)</code></pre>
                                            <p>
                                                The API also expects the user ID as a byte buffer:
                                            </p>
                                            <pre><code>        user: {
            displayName: "Test user",
            name: "test@example.com",
            id: base64urlToBuffer(UserId)
        },</code></pre>
                                            <p>
                                                Only the "public-key" type is supported for now. -7 means ECDSA with SHA-256. -37 for RSA with SHA-256 is also common.
                                                You can look up numbers and names <a target="_blank" href="https://www.iana.org/assignments/cose/cose.xhtml#algorithms">in this table</a>.
                                                For this example we will only do ECDSA with SHA-256, because that's what the YubiKey 4 uses.
                                            </p>
                                            <pre><code>        pubKeyCredParams: [
            {
                type: "public-key",
                alg: -7 // ECDSA SHA256
            }
        ],</code></pre>
                                            <p>
                                                <span class="mono">timeout</span> just refers to how long the prompt will wait.
                                            </p>
                                            <pre><code>        timeout: 10000,</code></pre>
                                            <p>
                                                <span class="mono">"direct"</span> means that the authenticator will need to prove that it's a hardware key by
                                                signing the response using a certificate whose private key is stored in the authenticator in a place where your
                                                computer can't read it. The server will 
                                                verify the signature and verify the certificate as proof that it's actually the authenticator that is responding.
                                            </p>
                                            <p>
                                                For example, on the YubiKey 4,
                                                you will get an attestation tied to a certificate from Yubico as evidence that this is a real YubiKey.
                                            </p>
                                            <pre><code>        attestation: "direct"
    }
};</code></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="subsection" expandable>
                                <h3 expandtoggle>
                                    <span class="expand">+</span>
                                    <span class="shrink">−</span>
                                    Call <span class="mono">navigator.credentials.create(options)</span>
                                </h3>
                                <div class="details">
                                    Stuff here.
                                </div>
                            </div>
                            <div class="subsection" expandable>
                                <h3 expandtoggle>
                                    <span class="expand">+</span>
                                    <span class="shrink">−</span>
                                    Pass response to server
                                </h3>
                                <div class="details">
                                    Stuff here.
                                </div>
                            </div>
                        </div>
                        <div class="tab-content" fortab="client-phase-python-tab">
                            <h2>
                                Native (python-fido2)
                            </h2>
                            <p>
                                I still recommend using WebAuthn because it abstracts the OS and hardware specific aspects. 
                                However, if you can't embed a web view, you can use client-side libraries to talk to the device. 
                                This tutorial uses 
                                <a target="_blank" href="https://github.com/Yubico/python-fido2">Yubico's FIDO2 library</a> to talk to a
                                USB authenticator.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="protocol-phase client-phase" expandable>
                <h1 class="phase-name" expandtoggle>
                    <span class="expand">+</span>
                    <span class="shrink">−</span>
                    &#x21c9; Signed Response
                </h1>
                <div class="details">
                    <p>
                        Client sends response with protocol bullshit
                    </p>
                </div>
            </div>
            <div class="protocol-phase server-phase" expandable>
                <h1 class="phase-name" expandtoggle>
                    <span class="expand">+</span>
                    <span class="shrink">−</span>
                    Validate Response
                </h1>
                <div class="details">
                    <p>
                        Server stores registration info
                    </p>
                </div>
            </div>
            <div class="protocol-phase server-phase" expandable>
                <h1 class="phase-name" expandtoggle>
                    <span class="expand">+</span>
                    <span class="shrink">−</span>
                    Save Registration
                </h1>
                <div class="details">
                    <p>
                        Server stores registration info
                    </p>
                </div>
            </div>
        </div>
        <div class="content-root">
            <h1>Title H1</h1>
            <h2>Section H2</h2>
            <h3>Subheading H3</h3>
            <p>Body text <a target="_blank" href="https://fidoalliance.org/specifications/">Reference Link</a></p>
            <code class="python">This is python code</code>
            <code class="javascript">This is javascript code</code>
            <code class="json">{inline json stuff}</code>
            <code class="hex">01 23 45 67 89 0A BC DE F0</code>
            <code class="base64">ThisIsWebSafeBase64</code>

            <div class="protocol-phase expandable" id="test_expandable">
                <div class="expandable-inner">
                    <div class="protocol-phase-header header">
                        <input class="protocol-phase-toggle" type="button" value="Explain" expandtarget="test_expandable">
                        <div class="protocol-phase-previewer">Name of Protocol Phase</div>
                    </div>
                    <div class="protocol-phase-detail detail">
                        <h1>Detail of Protocol Phase</h1>

                        <p>Explanation stuff here.</p>
                        <!--
                        <div class="data expandable" id="test_data">
                            <div class="data-header header" previewer>
                                <input class="data-toggle" type="button" value="Annotate" expandtarget="test_data">
                                <div class="data-previewer" preview>
                                    <code class="json">{Collapsed Json}</code>
                                </div>
                            </div>
                            <div class="data-expanded">
                                <code class="json">00 00 00 00</code>
                                <p>Description</p>
                                <code class="json">00 00 00 00</code>
                                <p>Description</p>
                                <code class="json">00 00 00 00</code>
                                <p>Description</p>
                            </div>
                        </div>

                        <div class="blob expandable" id="test_blob">
                            <div class="blob-header header" previewer>
                                <input class="blob-toggle" type="button" value="Decode" expandtarget="test_blob">
                                <div class="blob-previewer">
                                    <code class="base64">Base 64</code>
                                </div>
                            </div>
                            <div class="blob-expanded">
                                <code class="hex">00 00 00 00</code>
                            </div>
                        </div>

                        <div class="show-code expandable" id="test_showcode">
                            <div class="show-code-header header">
                                <input class="show-code-expand-button" type="button" value="Code" expandtarget="test_showcode" previewer>
                            </div>
                            <code class="show-code-expanded python">Detail code</code>
                        </div>
                        -->
                    </div>
                </div>
            </div>
        </div>
        <div class="page-footer">
            &copy; 2019 Andrew Gu | MIT License
        </div>
    </body>
    <script type="text/javascript" src="./include/util.js"></script>
    <script type="text/javascript">
        var formatMapping = {
            "expandable_attrb" : "expandable",
            "toggle_attrb" : "expandtoggle",
            "collapse_class" : "collapsed",
            "toggle_state_attrb" : "togglecollapsed",
            "tab_container_attrb" : "tabcontainer",
            "tab_selector_class" : "tab-selector",
            "tab_content_class" : "tab-content",
            "tab_content_key_attrb" : "fortab",
            "tab_visiblity_class" : "visible",
        };
        initInteractiveFormatting(formatMapping);
    </script>
</html>